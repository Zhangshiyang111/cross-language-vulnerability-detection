# Insights: Exploring Cross-Ecosystem Vulnerability Impacts

CLV issues： Vulnerability issues induced by cross-Language invocations.

## 一、综述        

现存的python/Java项目无法报告他们所调用依赖的包含漏洞的第三方库。本文提出了一个**端到端**的自动化工具INSIGHTS，**根据公开发表的C项目漏洞报告CVE识别PYPI和MAVEN项目中的CLV问题**。INSIGHTS会**自动识别**PYPI或MAVEN项目是否调用了存在CVE报告问题的C项目**版本**编译得到的**C库文件**。他还通过**分析不同类别的FFI**分析出了**易受攻击的API**。模型检测率很高达到了88.4%。

## 二、简介

### 1、困难

INSIGHTS需要克服的两个困难：

（1）CVE报告指出存在漏洞的**C项目的版本号**，PYPI或MAVEN项目构建脚本识别依赖的**C库版本号**，这两个版本。然而C库文件和他所相关的C项目有着不同的命名方式和版本控制方案。现实中一个**C项目版本对应着多个C库版本**，但是CVE报告中**只**会给出存在漏洞的**C项目版本**。近 80% 的 C 库违反了 Linux 社区中的语义版本控制规则。因此，**<u>依靠库的版本号无法可靠地识别其项目版本，也就无法识别是否调用了一个存在漏洞的项目版本。</u>**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          

（2）没有**支持不同的语法规则和机制**的**自动化分析技术**可以准确提取由**各种类型的FFI 调用的相关API**。

### 2、项目内容

INSIGHTS会自动持续监控含有漏洞的C库在PYPI和MAVEN生态中对用户项目的影响，并向项目开发者报告检测到的CLV问题。

**具体实现：**
（1）首先，为了确定C库是否会引入漏洞，要确定C库来源于什么版本的C项目。

> 首先，构建一个大规模知识库，为所有**C项目版本**的元数据和他们**已知的发表在主流LINUX上的编译库**之间**创建索引**。
>
> 其次，通过和我们**构建起的知识库中的C库**进行**相似度匹配确定一个C库的身份**（版本），使用工具LIBRARIAN。

（2）如果C库来源于存在CVE报告漏洞的C项目，则Insight 通过分析跨语言调用进一步分析相应易受攻击 API 的可访问性，并生成诊断报告。不同FFI会应用不同的跨语言分析方式。（CFFI,CPython，Cytpes，JNI,JNA）

### 3、本文贡献

（1）CLV问题检测工具INSIGHT：可以在跨语言项目中根据C项目的CVE报告自动检测和诊断CLV问题并且具有可扩展性。

（2）研究对CLV问题的普遍性及其传播方式进行了定量分析。由于一些关键项目和常用第三方库，CLV问题会在整个生态中不断传播造成威胁。

（3）提供可复现工具包，包括INSIGHT工具，包含检测到的CLV问题的数据集，目前生态系统中的大规模漏洞和库依赖数据。

### 4、背景知识

C库的发布和命名：

一个C项目编译成不同版本的C库文件，以.SO文件形式存在。

C库标准命名规则为：lib前缀+库的名字+.so后缀+版本号，但是80%左右的C库都没有标注版本号。

## 三、INSIGHT

实验利用INSIGHT在PYPI和MAVEN生态中持续检测并诊断由含有漏洞的C项目编译得到的C库文件引入的CLV问题。将直接调用C库的项目作为用户项目进行检测。包含三个阶段：**C库提取（根据项目在生态中的归档），C项目版本追踪，漏洞C-API分析**。

**（1）针对给定的JAVA/PYTHON项目，解析出C语言软件库。**

**（2）C语言软件库版本溯源：**

​          **a.构建C语言软件库与C语言软件项目之间的映射关系知识库；**

​          **b.结合知识库与二进制相似度匹配的方法识别其版本；**

**（3）安全漏洞C-API可达性分析：**

​          **a.外部调用接口FFI使用方式解析；**

​          **b.安全漏洞C-API调用路径解析；**

### 1、C Library Extraction

PYPI和MAVEN生态要求开发者在中心repositories中发布归档archives，记录二进制文件，配置文件和所有必要的依赖，包括使用的C库的副本，因此只要提取出archives文件中的.so文件即可找到使用的C库文件。

> 利用Wheel unpack和ZIPFILE工具进行文件浏览，直到所有包都被找到
>
> 在找到的包中根据正则表达式 “lib.+.so(.[0-9]+){0,3}”进行匹配得到调用的C库

### 2、C Project Version Tracing 

> 首先，构建一个大规模知识库，为所有**C项目版本**的元数据和他们**已知的发表在主流LINUX上的编译库**之间**创建索引**。
>
> 其次，通过和我们**构建起的知识库中的C库**进行**相似度匹配确定一个C库的身份**（版本），使用工具LIBRARIAN，并因此可以得到他所对应的C项目。

（1）**提取 C 库版本的表征特征**

每个C库都被打包为.so ELF二进制文件,每个文件都会包含一个符号表，记录**Exported Global（可从外部访问的可见变量）,Imported Globals（此库使用的来自其他库的变量）,Exported APIs（其他库可以调用的可见API）,Imported APIs（此库使用的来自其他库的API）,Dependencies（ELF中载入的库依赖关系）**等信息，INSIGHT学习LIBRARIAN将这五个特征作为区分不同库和版本的依据因为这五个特征比较稳定，不会根据底层架构和编译环境的变化而变化。

（2）**构建C库知识库**

通过抓取主流LINUX发行版中C项目的信息，构建一个大规模知识库，为所有C项目版本的元数据和由他们编译得到的C库之间建立索引。每个C库版本由之前提到的五个元素确定，而每个C项目版本由以下三个元数据确定：

<P,Lib,Src>

其中P:带有版本号的项目名称

Lib：该项目编译得到的C库的集合，每一个C库由连个元素组成，<soname,FV>,其中soname是库的名字，FV是上述提到的提取出的五个特征

Src：项目源代码

（3）**相似度匹配**

第一步，减少用于匹配的C库数量。利用库的名字进行匹配，利用正则表达式soname(˙[0-9]∗)，将返回值作为 进一步相似度匹配的候选项。

第二步，相似度匹配。将每个C库提取出的FV作为特征进行匹配，分数用bin^2sim(FV1,FV2)=|FV1∩FV2|/|FV1∪FV2|∈[0,1]表示，分数越大匹配性越高，将阈值设定为0.85，如果有多个匹配项得分高于阈值，则取最高的作为匹配结果。

### 3、Vulnerability C-API Analysis

INSIGHT通过分析跨语言调用来**报告项目是否能够调用C库中包含漏洞的API。**

（1）构建漏洞数据集

根据从三个官方安全建议网站收集到的漏洞报告元数据构建漏洞数据集。对于每个CVE报告，他都给出了**漏洞**独特的**识别标志，影响的项目，影响的项目版本，修复版本和安全级别**。同时，INSIGHT还会根据漏洞报告提供的信息识别github和gitlab的commits，并将相关commits中的API识别为有漏洞的API。INSIGHT会持续监控安全建议网站从而实时更新数据集。

（2）跨语言调用分析

运用构建出的漏洞数据集，对于每个用户项目中识别出的C库，INSIGHT都会检查他来自的**C项目是否包含CVE漏洞**，如果包含，则进一步识别代码**是否能够达到漏洞API**。此时INSIGHT将源代码和C库作为输入，输出一个**从入口C-API开始到相关C库中的漏洞函数的调用链的报告**，具体实现方法如下：

通过研究不同FFI的官方文档，我们设计了对五种FFI不同的分析模式，从而定位用户项目中对C库的入口API。

<u>利用不同FFI的prasing pattern 来定位entry C-API.为了获得函数调用表obtain function call graph within C libraries,rooting at the entry C-API, inside leverage CFLOWS,a static tool to analyse program control flows.</u>

## 四、实验案例与评价

### 1、INSIGHT有效性

收集数据集的标准：

（1）他们的提交日志消息明确指出修盯构建的脚本旨在纠正相关的 CVE问题

（2）包含测试文件，并且要测试这个测试文件是否真的能调用到存在漏洞的API

（3）比较流行，获得多余10的star

随后用INSIGHT在该数据集上测试是否能够识别出存在的CLV问题。如果一个项目中识别出的漏洞C项目版本在给出的区间内，那么认为INSIGHT正确识别，如果一个项目中包含多个有漏洞的C项目，那么只要识别出一个就认为INSIGHT正确识别漏洞。实验结果表明**正确率达到88.4%**，且没有出现假阳性的情况。对于失败的情况，主要是由于**bin^2sim分数没有达到阈值**导致的**C库识别失败**，以及**没有成功根据分析FFI得出漏洞API的可达性**。

> 每个CLV问题包含（用户项目版本，CVE标识符，包含漏洞的C项目名称，包含漏洞的C项目版本区间，C项目中与漏洞相关的API），其中后三个信息都可以在CVE报告中获得。

### 2、C语言软件库使用的普适性

少量主要项目的直接调用导致了大量下游项目对C库的间接调用。多数项目会调用多个C库，从而增加了他们被攻击的攻击面。

### 3、跨语言生态安全漏洞的传播影响

影响很大且有可能被低估，因为INSIGHT只定义了有限数量的CVE报告，未来的工作应当聚焦提高安全分析器的有效性，从而帮助开发人员捕获 CLV 问题。

### 4、INSIGHT的价值

将INSIGHT识别出的漏洞报告反馈给开发者后70%以上的漏洞已经被修复或正在被修复，约25%左右的漏洞被证实存在但是目前在修复中遇到了困难，约5%的漏洞报告被拒绝因为经过开发者的验证该漏洞不会在实际中被用户代码调用，剩余的漏洞由于项目不活跃等因素没有收到反馈。

API层级的CLV漏洞：项目的最新版本从C库中调用了包含漏洞的API

> 所有开发者收到报告后都很快给出修复的回复

库层级的CLV漏洞：重要项目的最新版本直接调用了包含漏洞的C库

> 由于不能明确指出存在漏洞的API，因此不能明确供给面，开发者给出意见认为自己应该对这个问题进行修复

### 5、修复策略及挑战

两种策略：

（1）直接更新直接或间接引入漏洞的C直接依赖（c direct dependencies）

（2）升级用户程序的目标OS

三个挑战：

（1）应对依赖冲突

（2）不知道为了修复漏洞应该将C依赖或者目标OS升级到什么版本

（3）需要请求linux社区重新调整调用的存在漏洞的库

### 6、有效性威胁

**内部有效性**：与C库的识别有关，目前的识别技术使用e LibRATIAN，但这可能导致连续版本的识别错误，因为连续版本的exported symbol可能没有变化。为了弥补这个问题，我们在我们构建的知识库中显著缩小了相似性匹配范围。

**结论有效性**：目前主要关注linux系统中的.so文件，后续应该扩充我们的知识库和特征提取技术从而处理windows系统中的.dll文件。

